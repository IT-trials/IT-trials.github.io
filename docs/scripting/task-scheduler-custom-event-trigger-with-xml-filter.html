<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Task Scheduler Custom Event Trigger with XML Filter and Parameter Output - IT Trials</title>
<meta name="description" content="Problem: I want to archive user files to a secure location on their logout.  I could probably do this with a logout script but I don’t want the user to have any access to the archive location.">


  <meta name="author" content="Craig Chamberlain">
  
  <meta property="article:author" content="Craig Chamberlain">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_GB">
<meta property="og:site_name" content="IT Trials">
<meta property="og:title" content="Task Scheduler Custom Event Trigger with XML Filter and Parameter Output">
<meta property="og:url" content="https://it-trials.craigchamberlain.it/scripting/task-scheduler-custom-event-trigger-with-xml-filter">


  <meta property="og:description" content="Problem: I want to archive user files to a secure location on their logout.  I could probably do this with a logout script but I don’t want the user to have any access to the archive location.">



  <meta property="og:image" content="https://it-trials.craigchamberlain.it/assets/images/it-trials.jpg">





  <meta property="article:published_time" content="2017-04-29T00:00:00+01:00">






<link rel="canonical" href="https://it-trials.craigchamberlain.it/scripting/task-scheduler-custom-event-trigger-with-xml-filter">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Craig Chamberlain",
      "url": "https://it-trials.craigchamberlain.it/",
      "sameAs": ["https://twitter.com/hagatorn","https://www.linkedin.com/in/craig-chamberlain-61037149","https://stackoverflow.com/users/3822155/craig-c"]
    
  }
</script>







<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="IT Trials Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          IT Trials
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/aws/">AWS</a>
            </li><li class="masthead__menu-item">
              <a href="/azure/">Azure</a>
            </li><li class="masthead__menu-item">
              <a href="/gpo/">Group Policy</a>
            </li><li class="masthead__menu-item">
              <a href="/mdt/">MS Deployment Toolkit</a>
            </li><li class="masthead__menu-item">
              <a href="/scripting/">Scripting</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="/assets/images/authors/1.jpg" alt="Craig Chamberlain" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Craig Chamberlain</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>Developer</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      
        
          
            <li><a href="mailto:craig@craigchamberlain.it" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span></a></li>
          
        
          
            <li><a href="https://craigchamberlain.it" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-link" aria-hidden="true"></i><span class="label">Website</span></a></li>
          
        
          
            <li><a href="https://twitter.com/hagatorn" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span></a></li>
          
        
          
            <li><a href="https://stackoverflow.com/users/3822155/craig-c" rel="nofollow noopener noreferrer"><i class="fab fa-stack-overflow" aria-hidden="true"></i><span class="label">Stack Overflow</span></a></li>
          
        
          
            <li><a href="https://www.linkedin.com/in/craig-chamberlain-61037149" rel="nofollow noopener noreferrer"><i class="fab fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Task Scheduler Custom Event Trigger with XML Filter and Parameter Output">
    <meta itemprop="description" content="Problem:I want to archive user files to a secure location on their logout.  I could probably do this with a logout script but I don’t want the user to have any access to the archive location.">
    <meta itemprop="datePublished" content="2017-04-29T00:00:00+01:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Trial #16: Task Scheduler Custom Event Trigger with XML Filter and Parameter Output
</h1>
          

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2017-04-29T00:00:00+01:00">April 29, 2017</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          2 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
        <h2 id="problem">Problem:</h2>
<p>I want to archive user files to a secure location on their logout.  I could probably do this with a logout script but I don’t want the user to have any access to the archive location.</p>

<h2 id="solution">Solution:</h2>
<p>Task Scheduler can run tasks and scripts as a privileged user but be triggered by a less privileged user or even an event.  For this reason I decided to use it to manage the archiving task.  It’s also useful to note, it’s possible to capture data from a trigger event to pass to a task and indeed the following solution does just that.</p>

<p><a href="https://blogs.technet.microsoft.com/wincat/2011/08/25/trigger-a-powershell-script-from-a-windows-event/" target="_blank">Technet</a> and <a href="https://community.spiceworks.com/how_to/123434-run-powershell-script-on-windows-event" target="_blank">spiceworks</a> have great articles on how to achieve this, which I followed them both in order to create my own similar solution.</p>

<p>In my case a number of exam service accounts have folder redirection for their desktop and user files to a network share.  These accounts might be used for several exams in one day and the old files must be archived between exams.  I decided to try and automate this at user logout as the students may be invigilated by people with basic access and ability with computers.  First I trawled the fileserver’s event logs for a relevant event.  This was actually really easy to isolate and event viewer will even write you a basic query you can then add more properties too.</p>

<p>I decided to add a user filter at this stage rather than handling inside Powershell to keep the noise down as I’m only interested in a small fraction of the logout events.</p>

<p>The following is an excerpt of the finished task sequence, as xml with both the event filter and custom output parameter marked at the bottom.
<img src="/assets/images/16/xml.jpg" alt="" /></p>

<p>Finally, for the specified users, Task Scheduler executes the Powershell script and passes in a parameter isolated manually in the above xml.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>powershell.exe -ExecutionPolicy Bypass -file "C:\Scripts\Supported Exam File Archiving.ps1" -username $(AccountName)  
</code></pre></div></div>

<p>I’ve included the Powershell which this schedule initiates in addition to an export of the task sequence as xml.  It includes my first implementation of the Powershell’s feature “SupportsShouldProcess” which is really useful and very easy to include, particularly if you have no need to further the default “-WhatIf” or “Confirm” functionality of the cmdlets you use within your script.</p>

<noscript><pre>400: Invalid request</pre></noscript>
<script src="https://gist.github.com/7be445c5037ba78b969e966e9ef17276.js"> </script>

<h2 id="pitfalls">Pitfalls:</h2>
<ul>
  <li>The query inside the schedule’s subscription is a bit fiddly if you aren’t familiar with the syntax.  My query was failing for quite a long time and I can’t say I know what I finally changed to fix it.</li>
  <li>It’s a pain that the query language doesn’t seem to support wild cards so repetitious matches must be declared longhand.  For example ` “Exam01”, “Exam02”, “Exam03”“…` An expression such as “EXM*” or “EXM%” more familiar in SQL and regex would be far more concise.</li>
  <li>It might be hard to predict exactly how and when all events will occur.  Therefore, you might end up triggering too many or two few tasks.  It’s therefore very important to test and regularly check a custom event trigger like this to make sure it does actually do the job you want it too.  For example I may have to cancel this schedule if the user share log-off occurs on a network interruption or a period on inactivity in addition to a full user logout on the client computer.</li>
</ul>

<h2 id="extension-ideas">Extension Ideas</h2>
<ul>
  <li>It may be more reliable to have a user log-off script trigger the scheduled task but I don’t know how to achieve that at this stage.</li>
</ul>

        
      </section>

      <footer class="page__meta">
        
        


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2017-04-29T00:00:00+01:00">April 29, 2017</time></p>


      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">Share on</h4>
  

  <a href="https://twitter.com/intent/tweet?text=Task+Scheduler+Custom+Event+Trigger+with+XML+Filter+and+Parameter+Output%20https%3A%2F%2Fit-trials.craigchamberlain.it%2Fscripting%2Ftask-scheduler-custom-event-trigger-with-xml-filter" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fit-trials.craigchamberlain.it%2Fscripting%2Ftask-scheduler-custom-event-trigger-with-xml-filter" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fit-trials.craigchamberlain.it%2Fscripting%2Ftask-scheduler-custom-event-trigger-with-xml-filter" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/scripting/wake-on-lan-with-pdq-query" class="pagination--pager" title="Wake on Lan Utility with PDQ Query and DHCP Option
">Previous</a>
    
    
      <a href="/scripting/installing-powershell-5-point-1" class="pagination--pager" title="Installing PowerShell 5.1
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You may also enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/scripting/saving-sensitive-data-to-file-with-powershell" rel="permalink">Trial #41: Saving Sensitive Data to File with PowerShell
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2023-02-24T00:00:00+00:00">February 24, 2023</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          1 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Problem:
You may want to store credentials on a computer for later use, either to save repeated entry or to allow for automation.  However, this information ...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/scripting/populate-active-directory-with-isams-pupil-data" rel="permalink">Trial #40: Populate Active Directory with iSAMS Pupil Data
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2023-02-24T00:00:00+00:00">February 24, 2023</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          2 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Problem:
If you work at a school using iSAMS, it is probably your trusted data source for pupil info such as preferred name.  But who maintains AD to make su...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/scripting/making-class-teams-with-the-microsoftteams-powershell-module" rel="permalink">Trial #39: Making Class Teams with the MicrosoftTeams PowerShell Module
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2023-02-24T00:00:00+00:00">February 24, 2023</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          2 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Problem:
We have c. 500 different sets, each with at least one teacher and many pupils.  This information is all available from our MIS but how can we automa...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/scripting/parsing-midyis-grade-exports" rel="permalink">Trial #38: Parsing and Transforming MidYIS grade export data
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2022-11-21T00:00:00+00:00">November 21, 2022</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          3 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Problem:
At the school at which I work, we had no way of importing our baseline MidYIS scores into our MIS and other custom reporting tools.  At times this i...</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    

    
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2023 IT Trials. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>







    
  <script>
    var disqus_config = function () {
      this.page.url = "https://it-trials.craigchamberlain.it/scripting/task-scheduler-custom-event-trigger-with-xml-filter";  /* Replace PAGE_URL with your page's canonical URL variable */
      this.page.identifier = "/scripting/task-scheduler-custom-event-trigger-with-xml-filter"; /* Replace PAGE_IDENTIFIER with your page's unique identifier variable */
    };
    (function() { /* DON'T EDIT BELOW THIS LINE */
      var d = document, s = d.createElement('script');
      s.src = 'https://ittrials.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


  





  </body>
</html>
